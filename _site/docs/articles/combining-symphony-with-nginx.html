<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>Combining Symphony with Nginx â€“ SymphonyCMS</title>
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <link media="screen" href="/symphony-2/css/codemirror.css" type="text/css" rel="stylesheet" />
        <link media="screen" href="/symphony-2/css/factory.css" type="text/css" rel="stylesheet" />
        <link media="screen" href="/symphony-2/css/factory.docs.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="/symphony-2/js/jquery.js"></script>
        <script type="text/javascript" src="/symphony-2/js/modernizr.js"></script>
        <script type="text/javascript" src="/symphony-2/js/codemirror.js"></script>
        <script type="text/javascript" src="/symphony-2/js/factory.js"></script>
        <script type="text/javascript" src="/symphony-2/js/factory.grid.js"></script>
    </head>
    <body>
        <aside id="network">

  <!-- Main navigation -->
  <header class="network-toolbar collapsed">
    <div class="field">
      <h1 class="network-logo column one">
        <a href="/docs/about.xml">Symphony CMS</a>
      </h1>
      <nav class="network-nav column">
        <a href="/docs/examples/community.xml">Community</a>
        <a href="/docs/examples/documentation.xml"  class="active">Documentation</a>
        <a href="/docs/examples/extensions.xml">Extensions</a>
        <a href="/docs/examples/ninjas.xml">Ninjas</a>
        <a href="/docs/examples/xpathr.xml">xPathr</a>
      </nav>
      <div id="user" class="network-user">
        <a href="http://getsymphony.com/get-involved/member/Allen/">
          <img src="img/user.png" width="35" height="35" alt="Allen Chang" />
        </a>
        <p>
          <a href="http://getsymphony.com/get-involved/currently-online/" class="network-visitors">15</a>
          <xsl:text> + </xsl:text>
          <a class="network-username">Allen Chang</a>
        </p>
      </div>
    </div>
  </header>

  <!-- User profile -->
  <div class="field network-profile">
    <form>

      <!-- Gravatar -->
      <div class="network-gravatar column one">
        <img src="img/user.png" width="174" height="174" alt="Allen Chang" />
        <p>Change your avatar at <a href="http://gravatar.com">Gravatar</a>.</p>
      </div>

      <!-- Information -->
      <fieldset class="column one large-two">
        <label for="profile-username" class="restricted">Username</label>
        <input id="profile-username" type="text" name="fields[username]" value="Allen" readonly="readonly" />
        <label for="profile-name">Name</label>
        <input id="profile-name" type="text" name="fields[name]" value="Allen Chang" />
        <label for="profile-email-address">Email (Private)</label>
        <input id="profile-email-address" type="text" name="fields[email-address]" value="team@getsymphony.com" />
        <label for="profile-city">Location</label>
        <input id="profile-city" type="text" name="fields[location]" value="Symphony Land" />
      </fieldset>
      <fieldset class="column two small-one">
        <label for="profile-website">Website</label>
        <input id="profile-website" type="text" name="fields[website]" value="http://getsymphony.com" />
        <label for="profile-bio">Bio</label>
        <textarea rows="7" name="fields[bio]">Cras mattis consectetur purus sit amet fermentum.</textarea>
        <div class="profile-controls">
          <button id="submit-profile" class="button-save" type="submit" name="action[members-edit]">Save Profile</button>
          <a class="button-cancel" href="../../member/Nils/">Cancel</a>
        </div>
      </fieldset>
    </form>
  </div>

  <!-- Site switcher -->
  <div class="field network-drawer">

    <!-- Symphony ressources -->
    <div class="column three medium-two">
      <h2>About Symphony</h2>
      <p>Symphony is an open source content management system for your websites and webapps. It makes complex things simple.</p>
      <div class="get-symphony">
        <a href="https://github.com/symphonycms/symphony-2">Get Symphony 2.3.0</a>
        <a href="https://github.com/symphonycms/symphony-2" class="icon-fork">Fork<span class="medium-hide"> on Github</span></a>
        <a href="https://github.com/symphonycms/symphony-2/archive/master.zip" class="icon-download"><span class="medium-hide">Download </span>ZIP</a>
      </div>
    </div>

    <!-- Symphony in other languages -->
    <div class="column one small-two">
      <h2>Regions</h2>
      <ul>
        <li>
          <a href="#">Germany</a>
        </li>
        <li>
          <a href="#">Italy</a>
        </li>
        <li>
          <a href="#">Romania</a>
        </li>
        <li>
          <a href="#">United Kingdom</a>
        </li>
      </ul>
    </div>

    <!-- Symphony ressources -->
    <div class="column one">
      <h2>Services</h2>
      <ul>
        <li>
          <a href="#">Github</a>
        </li>
        <li>
          <a href="#">Twitter</a>
        </li>
        <li>
          <a href="#">Vimeo</a>
        </li>
        <li>
          <a href="#">Flickr</a>
        </li>
      </ul>
    </div>
  </div>
</aside>

        <div id="site">
            <header class="site-header centered">
    <h1>
        <span>Symphony</span> Documentation
    </h1>
    <nav>
        <a href="about.xml">About</a>
        <a href="layouts.xml">Layouts</a>
        <a href="snippets.xml">Snippets</a>
        <a href="styles.xml">Styles</a>
        <a href="scripts.xml">Scripts</a>
        <a href="examples.xml">Examples</a>
    </nav>
</header>

            <div class="field">
  <div class="column sidebar infobox">
    
      <h3>Articles</h3>
      <ul class="sidebar-links">
        
          <li>
            <a href="/symphony-2/docs/articles/field-extension.html"
              >Field Extension</a>
            
          </li>
        
          <li>
            <a href="/symphony-2/docs/articles/getting-git-for-symphony-development.html"
              >Getting Git for Symphony Development</a>
            
          </li>
        
          <li>
            <a href="/symphony-2/docs/articles/combining-symphony-with-nginx.html"
               class="active">Combining Symphony with Nginx</a>
            
          </li>
        
      </ul>
    
      <h3>Book</h3>
      <ul class="sidebar-links">
        
          <li>
            <a href="/symphony-2/docs/book/symphony-book.html"
              >Symphony Start to Finish</a>
            
              <ul>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-01.html"
                      >Why You Need Symphony</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-02.html"
                      >Symphony in Action</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-03.html"
                      >Getting Started</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-04.html"
                      >Symphony Anatomy</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-05.html"
                      >Content</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-06.html"
                      >Front-end</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-07.html"
                      >Data Flow</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-08.html"
                      >Templating</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-09.html"
                      >System Management</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-10.html"
                      >Planning Symphony Projects</a>
                  </li>
                
                  <li>
                    <a href="/symphony-2/docs/book/chapter-11.html"
                      >Adaptive Techniques</a>
                  </li>
                
              </ul>
            
          </li>
        
      </ul>
    
      <h3>Concepts</h3>
      <ul class="sidebar-links">
        
          <li>
            <a href="/symphony-2/docs/concepts/xslt-transformation.html"
              >XSLT Transformation</a>
            
          </li>
        
      </ul>
    
      <h3>Guides</h3>
      <ul class="sidebar-links">
        
          <li>
            <a href="/symphony-2/docs/guides/javascript-styleguide.html"
              >JavaScript Style Guide</a>
            
          </li>
        
      </ul>
    
      <h3>Tutorials</h3>
      <ul class="sidebar-links">
        
      </ul>
    
      <h3>Working</h3>
      <ul class="sidebar-links">
        
          <li>
            <a href="/symphony-2/docs/working/a-symphony-workflow.html"
              >A Symphony Workflow</a>
            
          </li>
        
          <li>
            <a href="/symphony-2/docs/working/a-symphony-workflow-command-list.html"
              >A Symphony Workflow - Terminal Command List</a>
            
          </li>
        
          <li>
            <a href="/symphony-2/docs/working/installing-on-mac-osx.html"
              >Installing Symphony on your Mac (OS X >= 10.5)</a>
            
          </li>
        
          <li>
            <a href="/symphony-2/docs/working/a-view-on-static-pages.html"
              >A view on static pages</a>
            
          </li>
        
          <li>
            <a href="/symphony-2/docs/working/understanding-xslt.html"
              >Understanding XSLT</a>
            
          </li>
        
      </ul>
    
  </div>
  <div class="column content">
      <h2>META</h2>

<ul>
<li>Doc Version: 110710</li>
<li>Author: Rowan Lewis</li>
<li>Applies to: 2.x</li>
<li>Based on: 2.1.0</li>
<li>Production URL: http://symphonycms.com/learn/articles/view/combining-symphony-with-nginx/</li>
</ul>

<h1>Combining Symphony with Nginx</h1>

<p><a href="http://wiki.nginx.org/Main">Nginx</a> is a powerful, lightweight web server. Today Iâ€™ll show you how to rewrite your URLs for a typical Symphony installation.</p>

<p>First, create a new <code>location</code> rule in your Nginx configuration. This can be in the main server configuration or in an included configuration file in your web folder. If you didn&#39;t configure Nginx yourself, then your hosting provider may provide more detailed instructions on what file to edit.</p>

<p>Iâ€™m assuming that your Symphony installation is in a subfolder in your web space, such as <code>symphony/2.1.0</code>. If it isnâ€™t, donâ€™t worry, because I cover that later.</p>

<p>Add this line to your configuration:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">location ~ ^(?&lt;path&gt;/symphony/2.1.0)/(?&lt;admin&gt;symphony)?(?&lt;page&gt;.*)$ {
</code></pre></div>
<p>Looks a little confusing, I know, so hereâ€™s a quick breakdown:</p>

<ul>
<li><code>location ~</code> Create a new location that matches this expression</li>
<li><code>^(?&lt;path&gt;/symphonyâ€¦)/</code> Match any URL that starts with /symphony/2.1.0 and assign it to the variable <code>$path</code></li>
<li><code>(?&lt;admin&gt;symphony)?</code> Optionally match symphony and assign it to the variable <code>$admin</code></li>
<li><code>(?&lt;page&gt;.*)$</code> Match anything until the end of the URL and assign it to the variable <code>$page</code></li>
</ul>

<p>Essentially, this matches the basic structure of any Symphony URL and lets us run more tests on <code>$path</code>, <code>$admin</code> and <code>$page</code>.</p>

<h2>Ignore files</h2>

<p>Next, prevent Nginx from rewriting files that actually exist in your Symphony installation.  If you donâ€™t do this step,  you wonâ€™t be able to load any images, stylesheets or scripts on your website:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># Allow access to files:
if (-f $request_filename) {
    break;
}
</code></pre></div>
<p>This tells Nginx to stop <code>(break)</code> rewriting when the current URL matches a file that exists on the file system (-f).</p>

<h2>Image Manipulation</h2>

<p>If you use <a href="http://symphony-cms.com/download/extensions/view/20046/">Alistair&#39;s JIT Image Manipulation extension</a>, then you should add the following rule:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># Just In Time Image Manipulation:
if ($page ~ ^image/(.+\.(jpg|gif|jpeg|png|bmp))$) {
    rewrite . $path/extensions/jit_image_manipulation/lib/image.php?param=$1 last;
}
</code></pre></div>
<h2>Trailing slashes</h2>

<p>Some people prefer to force trailing slashes on the and of their URLs, so if you visited <code>http://yourhost.com/symphony/2.1.0/about</code> it would automatically send you to <code>about/</code>. This is easy enough to do:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># Add trailing slashes:
if ($request_filename !~ &quot;/$&quot;) {
    rewrite ^(.*)$ $1/ redirect;
}
</code></pre></div>
<p>However, if you want to remove trailing slashes, then things get a little more interesting.  Because Nginx doesnâ€™t support nested if statements, or allow testing two conditions in one if statement, we find ourselves doing this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># Remove trailing slashes:
set $test &quot;&quot;;

if ($request_filename ~ &quot;/$&quot;) {
    set $test &quot;${test}o&quot;;
}

if (!-d $request_filename) {
    set $test &quot;${test}k&quot;;
}

if ($test = &quot;ok&quot;) {
    rewrite ^(.*)/$ $1 redirect;
}
</code></pre></div>
<p>What does this do?</p>

<ol>
<li>Check to see if the current URL has a trailing slash, if it does, then add &quot;<code>o</code>&quot; to <code>$test</code>,</li>
<li>Check to see if the current URL is not a directory, then add &quot;<code>k</code>&quot; to <code>$test</code>,</li>
<li>Check to make sure <code>$test</code> is equal to &quot;<code>ok</code>&quot;, in which case, redirect to the current URL without a trailing slash.</li>
</ol>

<h2>Deny access</h2>

<p>Symphony stores some potentially sensitive files in the <code>manifest</code> folder, and you don&#39;t want anything inside of it to be publicly visible:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># Block access to manifest:
if ($page ~ &quot;^manifest/&quot;) {
    return 403;
}
</code></pre></div>
<p>Yes, that matches <code>$path</code> when it starts with <code>manifest/</code> and returns a 403 Forbidden message to the browser.</p>

<h2>The main rewrite</h2>

<p>Now all thatâ€™s left to do is send <code>$page</code> to Symphony:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># Access Symphony backend:
if ($admin) {
    rewrite . $path/index.php?mode=administration&amp;symphony-page=$page last;
}

# Access Symphony frontend:
if ($page) {
    rewrite . $path/index.php?symphony-page=$page last;
}
</code></pre></div>
<p>In these two rewrites, we donâ€™t actually care about matching anything, as all of the information we need is in the <code>$path</code>, <code>$admin</code> and <code>$page</code> varables.</p>

<p>So, what does the entire <code>location</code> look like?</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">location ~ ^(?&lt;path&gt;/symphony/2.1.0)/(?&lt;admin&gt;symphony)?(?&lt;page&gt;.*)$ {
    # Allow access to files:
    if (-f $request_filename) {
        break;
    }

    # Just In Time Image Manipulation:
    if ($page ~ ^image/(.+\.(jpg|gif|jpeg|png|bmp))$) {
        rewrite . $path/extensions/jit_image_manipulation/lib/image.php?param=$1 last;
    }

    # Add trailing slashes:
    if ($request_filename !~ &quot;/$&quot;) {
        rewrite ^(.*)$ $1/ redirect;
    }

    # Block access to manifest:
    if ($page ~ &quot;^manifest/&quot;) {
        return 403;
    }

    # Access Symphony backend:
    if ($admin) {
        rewrite . $path/index.php?mode=administration&amp;symphony-page=$page last;
    }

    # Access Symphony frontend:
    if ($page) {
        rewrite . $path/index.php?symphony-page=$page last;
    }
}
</code></pre></div>
<p>Again, the above only works for a Symphony installation in the <code>/symphony/2.1.0</code> folder of your web server, if your installation is in the root folder, then change the first line to read:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">location ~ ^(?&lt;path&gt;)/(?&lt;admin&gt;symphony)?(?&lt;page&gt;.*)$ {
</code></pre></div>
<p>Yep, itâ€™s that simple!</p>

  </div>
</div>

        </div>

        <footer id="footer">
  <div class="field">

    <!-- Community -->
    <p class="footer-community">
      <strong>&#169; 2010â€“2012 The Symphony Community</strong>
      <a href="http://getsymphony.com">International Site</a> Â· <a href="http://twitter.com/symphonycms">Twitter</a>
    </p>

    <!-- Developer links -->
    <p class="footer-links">
      <strong>Plan, Play and Practice</strong>
      <a href="https://github.com/symphonycms/symphony-2/blob/master/README.markdown">Requirements</a> Â· <a href="https://github.com/symphonycms/symphony-2/blob/master/LICENCE">MIT Licence</a> Â· <a href="http://github.com/symphonycms">Github</a>
    </p>

    <!-- Factory artwork -->
    <p class="footer-factory">
      <em>Conducting sites since 2004</em>
      <a href="http://getsymphony.com">Symphony Community</a>
    </p>
  </div>
</footer>
    </body>
</html>
